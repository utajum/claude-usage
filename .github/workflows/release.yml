name: Release

on:
  push:
    branches: [main, master]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for tags

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Get latest tag and increment version
        id: version
        run: |
          # Get latest tag or default to v0.0.0
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"
          
          # Extract version numbers
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # Increment patch version
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
          
          echo "New version: $NEW_VERSION"
          echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT

      - name: Build Linux (amd64)
        run: |
          GOOS=linux GOARCH=amd64 go build \
            -ldflags "-X main.Version=${{ steps.version.outputs.new_version }}" \
            -o dist/claude-usage-linux-amd64 \
            ./cmd/claude-usage

      - name: Build Linux (arm64)
        run: |
          GOOS=linux GOARCH=arm64 go build \
            -ldflags "-X main.Version=${{ steps.version.outputs.new_version }}" \
            -o dist/claude-usage-linux-arm64 \
            ./cmd/claude-usage

      - name: Build Windows (amd64)
        run: |
          GOOS=windows GOARCH=amd64 go build \
            -ldflags "-X main.Version=${{ steps.version.outputs.new_version }} -H=windowsgui" \
            -o dist/claude-usage-windows-amd64.exe \
            ./cmd/claude-usage

      - name: Build macOS (amd64 - Intel)
        run: |
          GOOS=darwin GOARCH=amd64 go build \
            -ldflags "-X main.Version=${{ steps.version.outputs.new_version }}" \
            -o dist/claude-usage-darwin-amd64 \
            ./cmd/claude-usage

      - name: Build macOS (arm64 - Apple Silicon)
        run: |
          GOOS=darwin GOARCH=arm64 go build \
            -ldflags "-X main.Version=${{ steps.version.outputs.new_version }}" \
            -o dist/claude-usage-darwin-arm64 \
            ./cmd/claude-usage

      - name: List built artifacts
        run: ls -la dist/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_version }}
          name: Release ${{ steps.version.outputs.new_version }}
          body: |
            ## Claude Usage ${{ steps.version.outputs.new_version }}
            
            ### Downloads
            
            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | Linux | x64 | `claude-usage-linux-amd64` |
            | Linux | ARM64 | `claude-usage-linux-arm64` |
            | Windows | x64 | `claude-usage-windows-amd64.exe` |
            | macOS | Intel | `claude-usage-darwin-amd64` |
            | macOS | Apple Silicon | `claude-usage-darwin-arm64` |
            
            ### Installation
            
            **Linux/macOS:**
            ```bash
            chmod +x claude-usage-*
            ./claude-usage-linux-amd64  # or appropriate binary
            ```
            
            **Windows:**
            Just download and run the `.exe` file.
            
            ---
            *Auto-generated release from commit ${{ github.sha }}*
          files: |
            dist/claude-usage-linux-amd64
            dist/claude-usage-linux-arm64
            dist/claude-usage-windows-amd64.exe
            dist/claude-usage-darwin-amd64
            dist/claude-usage-darwin-arm64
          generate_release_notes: true
